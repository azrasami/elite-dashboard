<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Elite Ads Decision Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        padding: 30px;
      }

      .container {
        max-width: 1000px;
        margin: auto;
      }

      h1 {
        text-align: center;
        margin-bottom: 10px;
      }

      .subtitle {
        text-align: center;
        color: #555;
        margin-bottom: 30px;
      }

      .input-box {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 25px;
      }

      input {
        padding: 10px;
        width: 220px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      button {
        padding: 10px 20px;
        background: black;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .note {
        text-align: center;
        font-size: 13px;
        color: #666;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        background: white;
        border-radius: 10px;
        border-collapse: collapse;
        overflow: hidden;
      }

      th,
      td {
        padding: 14px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #f3f4f6;
        font-size: 14px;
      }

      .win {
        color: #16a34a;
        font-weight: bold;
      }

      .lose {
        color: #dc2626;
        font-weight: bold;
      }

      .nodata {
        color: #6b7280;
        font-weight: bold;
      }

      .decision {
        font-size: 15px;
      }

      .reason {
        font-size: 13px;
        color: #444;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Elite Ads Decision Tool</h1>
      <div class="subtitle">
        Decide which ads to stop, keep, or wait on â€” in seconds.
      </div>

      <div class="input-box">
        <input id="adAccount" placeholder="Ad Account ID (act_...)" />
        <input id="accessToken" placeholder="Read-only Meta Token" />
        <input id="targetRoas" placeholder="Target ROAS" value="2" />
        <input id="minSpend" placeholder="Min Spend ($)" value="3" />
        <button onclick="fetchAds()">Get Decisions</button>
      </div>

      <div class="note">
        ðŸ”’ We only read ad performance. We cannot create, edit, or pause ads.
      </div>

      <table>
        <thead>
          <tr>
            <th>Decision</th>
            <th>Ad Name</th>
            <th>Spend</th>
            <th>ROAS</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody id="adsTable"></tbody>
      </table>
    </div>

    <script>
      async function fetchAds() {
        const act = document.getElementById("adAccount").value.trim();
        const token = document.getElementById("accessToken").value.trim();
        const targetRoas = document.getElementById("targetRoas").value.trim();
        const minSpend = document.getElementById("minSpend").value.trim();

        if (!act || !token) {
          alert("Please enter Ad Account ID and Token");
          return;
        }

        const url =
          `/api/ads?adAccount=${encodeURIComponent(act)}` +
          `&token=${encodeURIComponent(token)}` +
          `&targetRoas=${encodeURIComponent(targetRoas || "2")}` +
          `&minSpend=${encodeURIComponent(minSpend || "3")}`;

        const res = await fetch(url);
        const json = await res.json();

        if (!res.ok) {
          alert(json.error || "Error fetching ads");
          renderAds([]);
          return;
        }

        renderAds(json.ads || []);
      }

      function decisionClass(decision) {
        if (decision === "KEEP") return "win";
        if (decision === "STOP") return "lose";
        return "nodata";
      }

      function renderAds(ads) {
        const table = document.getElementById("adsTable");
        table.innerHTML = "";

        if (!ads.length) {
          table.innerHTML =
            `<tr><td class="nodata" colspan="5">No ads returned.</td></tr>`;
          return;
        }

        // ØªØ±ØªÙŠØ¨: STOP Ø£ÙˆÙ„Ù‹Ø§ØŒ Ø«Ù… TOO_EARLYØŒ Ø«Ù… KEEP
        const order = { STOP: 1, TOO_EARLY: 2, KEEP: 3 };
        ads.sort(
          (a, b) => (order[a.decision] || 9) - (order[b.decision] || 9)
        );

        ads.forEach((ad) => {
          const cls = decisionClass(ad.decision);
          table.innerHTML += `
            <tr>
              <td class="decision ${cls}">${ad.decision}</td>
              <td>${escapeHtml(ad.name)}</td>
              <td>$${Number(ad.spend || 0).toFixed(2)}</td>
              <td>${Number(ad.roas || 0).toFixed(2)}</td>
              <td class="reason">${escapeHtml(ad.reason || "")}</td>
            </tr>
          `;
        });
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
    </script>
  </body>
</html>
